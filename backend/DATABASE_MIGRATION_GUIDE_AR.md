# دليل ترحيل قاعدة البيانات لتطبيق StockMaster Pro

يشرح هذا الدليل كيفية التعامل بشكل صحيح مع تغييرات مخطط قاعدة البيانات في تطبيق StockMaster Pro باستخدام Flask-Migrate.

## أهمية ترحيل قاعدة البيانات

عندما تقوم بتعديل نماذج قاعدة البيانات (إضافة أو إزالة أو تغيير الحقول)، يجب أن تنعكس هذه التغييرات في مخطط قاعدة البيانات الفعلي. بدون الترحيلات المناسبة:

- سيحاول التطبيق الوصول إلى أعمدة غير موجودة في قاعدة البيانات
- هذا يؤدي إلى استثناءات `OperationalError` مثل `no such column: users.theme_color`
- يتم إبطاء التطوير بسبب تصحيح الأخطاء غير الضروري
- قد يتم فقدان البيانات عند تعديل المخطط يدويًا

## الإعداد الأولي

إذا لم تقم بإعداد Flask-Migrate بعد، قم بتشغيل:

```bash
python setup_migrations.py
```

هذا سوف:
1. يقوم بتهيئة دليل الترحيلات
2. إنشاء ترحيل أولي بناءً على النماذج الحالية
3. تطبيق الترحيل على قاعدة البيانات

## سير العمل لإجراء تغييرات في المخطط

### 1. تعديل النموذج

عندما تحتاج إلى تغيير مخطط قاعدة البيانات، قم أولاً بتحديث النموذج في `database/models.py` أو ملفات النموذج الأخرى:

```python
# مثال: إضافة حقل جديد إلى نموذج User
class User(db.Model):
    # الحقول الموجودة...
    
    # حقل جديد
    new_field = db.Column(db.String(50), default='default_value')
```

### 2. إنشاء ترحيل

بعد تعديل النموذج، قم بإنشاء ترحيل لالتقاط التغييرات:

```bash
cd backend
flask db migrate -m "إضافة حقل new_field إلى نموذج User"
```

هذا الأمر:
- يقارن النماذج مع مخطط قاعدة البيانات الحالي
- ينشئ نص ترحيل في `migrations/versions/`
- يحتوي النص على أوامر SQL اللازمة لتحديث قاعدة البيانات

### 3. مراجعة الترحيل

**مهم**: قم دائمًا بمراجعة نص الترحيل المنشأ قبل تطبيقه!

- افتح الملف المنشأ حديثًا في `migrations/versions/`
- تأكد من أنه يلتقط تغييراتك بشكل صحيح
- قد يفوت Alembic بعض التغييرات (خاصة للفهارس والقيود وما إلى ذلك)
- أضف أي عمليات مفقودة يدويًا إذا لزم الأمر

### 4. تطبيق الترحيل

بعد مراجعة نص الترحيل، قم بتطبيقه لتحديث مخطط قاعدة البيانات:

```bash
cd backend
flask db upgrade
```

هذا الأمر ينفذ نص الترحيل لتحديث مخطط قاعدة البيانات.

### 5. اختبار التغييرات

بعد تطبيق الترحيل:
- قم بتشغيل التطبيق
- اختبر الوظائف المتأثرة
- تحقق من عدم وجود استثناءات `OperationalError`

## أوامر الترحيل الشائعة

### إنشاء ترحيل

```bash
flask db migrate -m "وصف التغييرات"
```

### تطبيق الترحيلات

```bash
flask db upgrade
```

### التراجع إلى الترحيل السابق

```bash
flask db downgrade
```

### عرض تاريخ الترحيل

```bash
flask db history
```

### عرض الترحيل الحالي

```bash
flask db current
```

## أفضل الممارسات

1. **قم دائمًا بإنشاء ترحيلات للتغييرات في المخطط** - لا تقم أبدًا بتعديل مخطط قاعدة البيانات يدويًا

2. **ترحيل واحد لكل ميزة** - قم بتجميع تغييرات النموذج ذات الصلة في ترحيل واحد

3. **رسائل ترحيل وصفية** - استخدم رسائل واضحة تصف ما يفعله الترحيل

4. **مراجعة الترحيلات قبل التطبيق** - قد لا يكتشف Alembic جميع التغييرات

5. **الاختبار بعد الترحيل** - تحقق من أن التطبيق يعمل بشكل صحيح مع المخطط الجديد

6. **الالتزام بالترحيلات في نظام التحكم بالإصدار** - يجب تتبع نصوص الترحيل في git

7. **التنسيق مع أعضاء الفريق** - تأكد من أن الجميع يطبقون الترحيلات عند سحب التغييرات

## استكشاف الأخطاء وإصلاحها

### OperationalError: no such column

إذا واجهت خطأ مثل `OperationalError: no such column: users.theme_color`:

1. تحقق مما إذا كنت قد أنشأت وطبقت ترحيلًا للعمود
2. قم بتشغيل `flask db migrate` متبوعًا بـ `flask db upgrade`
3. إذا استمرت المشكلة، تحقق مما إذا كان نص الترحيل يضيف العمود بشكل صحيح

### تعارضات الترحيل

إذا واجهت تعارضات عندما ينشئ عدة مطورين ترحيلات:

1. تواصل مع فريقك حول تغييرات المخطط
2. اسحب أحدث التغييرات قبل إنشاء ترحيلات جديدة
3. ادمج الترحيلات بعناية، مع مراعاة ترتيب العمليات

## هل تحتاج إلى مساعدة؟

إذا واجهت مشكلات في الترحيلات، اتصل بالمطور الرئيسي أو مسؤول قاعدة البيانات للحصول على المساعدة.

تذكر: **قم دائمًا بتشغيل الترحيلات بعد سحب التغييرات التي تتضمن تعديلات على النموذج!**
